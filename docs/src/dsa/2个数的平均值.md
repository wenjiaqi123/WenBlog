# 求2个数的平均值

## 需求

求2个数 a , b 的平均值？ 

或者求一段数组的中点？比如数组长度为 Length，给2个值，Left 和 Right，求 [Left,Right] 数组的中点



## 错误做法

```java
//很多人第一想法,平均值这不简单？
int avg = (a+b)/2;
```

```java
int avg = (Left + Right)/2;
```



## 思考

如果 a 和  b 都很大，以 int 举例，int 的最大值是 21 亿（2147483647），a = 10亿，b = 20亿

那么 a+b 就 30亿了，这时候已经超出 int 值的最大范围，丢失精度，再除以 2 就会得到一个错误的数。

```java
public static void main(String[] args) {
    int a = 1_000_000_000;	//10亿
    int b = 2_000_000_000;	//20亿

    int sum = a+b;
    System.out.println("sum= " + sum);		//sum= -1294967296

    int avg = sum/2;
    System.out.println("avg= " + avg);		//avg= -647483648
}
```



## 正确做法

```java
public static void main(String[] args) {
    int a = 1_000_000_000;	//10亿
    int b = 2_000_000_000;	//20亿

    int a1 = a + (b-a)/2;			//正确【推荐】
    int a2 = a + (b-a) >> 1;		//错误	//因为位运算的优先级最低,先算 (b-a) 结果和 a+ 最后算 >>1 
    int a3 = a + ((b-a) >> 1);		//正确,虽然移位操作性能比 /2 要好一点点,但是服务器对这么一点资源还是OK的

    System.out.println("a1 = " + a1);	//a1 = 1500000000
    System.out.println("a2 = " + a2);	//a2 = 1000000000
    System.out.println("a3 = " + a3);	//a3 = 1500000000
}
```

- 单目运算符 > 双目运算符。先乘除，后加减，再移位



## 奇技淫巧

算法虽然优秀，但是有时候也得考虑现实中，同一个项目组的其他人不是像你这么优秀的。所以我把这些称为奇技淫巧。

有优化这个的时间，不如去把排序优化下，因为一个排序的优化，远比优化这个来得更加重要。

```java
//向下取整
int avg1 = (a & b) + ((a ^ b) >> 1);
//向上取整
int avg2 = (a | b) - ((a ^ b) >> 1);
```

- 假设 a=3，b=5

	- ```
		a	0011	=3
		b	0101	=5
		--------
		&	0001	=1
		```

	- ```
		a	0011	=3
		b	0101	=5
		--------
		^	0110	=6
		```

	- "与" 就是2个数之间相同的部分。a&b = 1，那么先让 a-1=2，b-1=4。这个2和4就是 a 和 b 不同的地方

		- b 和 a 的差值 = 4-2 的差值

	- "异或" 就是2个数的 并集-交集，(2+1+4)-1 = 2+4，进行 >> 1 得到两数之差

- 假设 a=3，b=6

	- ```
		a	0011	=3
		b	0110	=6
		--------
		&	0011	=2
		```

	- ```
		a	0011	=3
		b	0110	=6
		--------
		^	0101	=5
		```

	- "与" 就是2个数之间相同的部分。a&b = 2，那么先让 a-2=1，b-2=4。这个1和4就是 a 和 b 特有的数据
		- b 和 a 的差值 = 4-1 的差值
	- "异或" 就是2个数的 并集-交集，(2+1+4)-1 = 2+4，进行 >> 1 得到两数之差